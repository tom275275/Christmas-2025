<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tom's Christmas Command Center</title>
    
    <!-- 1. Load Tailwind CSS (Styling) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Load React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 3. Load Babel (translates React to browser code on the fly) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Styles for nice scrollbars -->
    <style>
        body { background-color: #f8fafc; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        @keyframes pulse-subtle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .sync-pulse { animation: pulse-subtle 1.5s ease-in-out infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // ============== JSONBIN CONFIG ==============
        const JSONBIN_BIN_ID = '692a226cae596e708f775477';
        const JSONBIN_API_KEY = '$2a$10$Me1AY5oZIu8mi4yVqzTIx.O/LuY2a3CzbwYyf.IfwTIoPc4DYYex6';
        const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`;
        // ============================================

        // --- Icons (Inline SVGs to remove external dependencies) ---
        const Icon = ({ path, className = "w-4 h-4" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const Icons = {
            Gift: (props) => <Icon {...props} path={<><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13"/><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7"/><path d="M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.9 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"/></>} />,
            DollarSign: (props) => <Icon {...props} path={<><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></>} />,
            CheckCircle2: (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></>} />,
            Circle: (props) => <Icon {...props} path={<circle cx="12" cy="12" r="10"/>} />,
            Package: (props) => <Icon {...props} path={<><path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22v-10"/></>} />,
            Plus: (props) => <Icon {...props} path={<><path d="M5 12h14"/><path d="M12 5v14"/></>} />,
            Copy: (props) => <Icon {...props} path={<><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></>} />,
            Save: (props) => <Icon {...props} path={<><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>} />,
            Upload: (props) => <Icon {...props} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></>} />,
            Edit2: (props) => <Icon {...props} path={<path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>} />,
            ExternalLink: (props) => <Icon {...props} path={<><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></>} />,
            Users: (props) => <Icon {...props} path={<><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>} />,
            Cloud: (props) => <Icon {...props} path={<path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/>} />,
            CloudOff: (props) => <Icon {...props} path={<><path d="m2 2 20 20"/><path d="M5.782 5.782A7 7 0 0 0 9 19h8.5a4.5 4.5 0 0 0 1.307-.193"/><path d="M21.532 16.5A4.5 4.5 0 0 0 17.5 10h-1.79A7.008 7.008 0 0 0 10 5.07"/></>} />,
            RefreshCw: (props) => <Icon {...props} path={<><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></>} />,
        };

        // --- Sync Status Indicator ---
        const SyncStatus = ({ status }) => {
            const config = {
                synced: { icon: Icons.Cloud, text: 'Synced', className: 'text-green-600' },
                syncing: { icon: Icons.RefreshCw, text: 'Saving...', className: 'text-blue-500 sync-pulse' },
                offline: { icon: Icons.CloudOff, text: 'Offline', className: 'text-amber-500' },
                error: { icon: Icons.CloudOff, text: 'Sync error', className: 'text-red-500' },
            };
            const { icon: IconComp, text, className } = config[status] || config.synced;
            
            return (
                <div className={`flex items-center gap-1.5 text-xs font-medium ${className}`}>
                    <IconComp className="w-3.5 h-3.5" />
                    <span>{text}</span>
                </div>
            );
        };

        // --- Components ---

        const StatusBadge = ({ status }) => {
            const styles = {
                'Idea': 'bg-gray-100 text-gray-600 border-gray-200',
                'Ordered': 'bg-blue-100 text-blue-700 border-blue-200',
                'Received': 'bg-orange-100 text-orange-700 border-orange-200',
                'Wrapped': 'bg-green-100 text-green-700 border-green-200',
            };

            const icons = {
                'Idea': <Icons.Circle className="w-3 h-3 mr-1" />,
                'Ordered': <Icons.DollarSign className="w-3 h-3 mr-1" />,
                'Received': <Icons.Package className="w-3 h-3 mr-1" />,
                'Wrapped': <Icons.CheckCircle2 className="w-3 h-3 mr-1" />,
            };

            return (
                <span className={`flex items-center px-2 py-1 rounded-full text-xs font-medium border ${styles[status]}`}>
                    {icons[status]}
                    {status}
                </span>
            );
        };

        const ProgressBar = ({ current, max, label }) => {
            const percentage = Math.min(100, Math.max(0, (current / max) * 100)) || 0;
            const isOver = current > max;
            
            return (
                <div className="w-full">
                    <div className="flex justify-between text-xs mb-1">
                        <span className="font-medium text-gray-600">{label}</span>
                        <span className={`${isOver ? 'text-red-600 font-bold' : 'text-gray-500'}`}>
                            ${current.toLocaleString()} / ${max.toLocaleString()}
                        </span>
                    </div>
                    <div className="h-2 w-full bg-gray-200 rounded-full overflow-hidden">
                        <div 
                            className={`h-full transition-all duration-500 ${isOver ? 'bg-red-500' : 'bg-emerald-500'}`}
                            style={{ width: `${percentage}%` }}
                        />
                    </div>
                </div>
            );
        };

        // --- Main App ---

        function GiftTracker() {
            const [people, setPeople] = useState([]);
            const [isImportModalOpen, setIsImportModalOpen] = useState(false);
            const [importText, setImportText] = useState('');
            const [editingPersonId, setEditingPersonId] = useState(null);
            const [editingGiftId, setEditingGiftId] = useState(null);
            const [expandedPeople, setExpandedPeople] = useState(new Set());
            const [sortBy, setSortBy] = useState('recipient'); // 'recipient', 'status', 'assigned'
            const [syncStatus, setSyncStatus] = useState('syncing');
            const [isLoaded, setIsLoaded] = useState(false);

            const saveTimeoutRef = useRef(null);

            // Migration helper: convert old flat gift structure to new nested person/gifts structure
            const migrateData = (data) => {
                if (!Array.isArray(data) || data.length === 0) return data;

                // Check if data is already in new format (has 'gifts' array)
                if (data[0].gifts !== undefined) return data;

                // Old format detected - convert it
                const peopleMap = new Map();

                data.forEach(oldGift => {
                    const recipientKey = oldGift.recipient || 'Unknown';

                    if (!peopleMap.has(recipientKey)) {
                        peopleMap.set(recipientKey, {
                            id: `person-${Date.now()}-${Math.random()}`,
                            recipient: recipientKey,
                            assignedTo: oldGift.assignedTo || '',
                            gifts: []
                        });
                    }

                    const person = peopleMap.get(recipientKey);
                    person.gifts.push({
                        id: oldGift.id || `gift-${Date.now()}-${Math.random()}`,
                        item: oldGift.item || '',
                        price: Number(oldGift.price) || 0,
                        budget: Number(oldGift.budget) || 0,
                        status: oldGift.status || 'Idea',
                        link: oldGift.link || '',
                        notes: oldGift.notes || '',
                        expectedDelivery: oldGift.expectedDelivery || ''
                    });
                });

                return Array.from(peopleMap.values());
            };

            // Load from JSONBin on mount
            useEffect(() => {
                const loadData = async () => {
                    // First, try localStorage for instant display
                    const cached = localStorage.getItem('tom_gift_tracker_v1');
                    if (cached) {
                        try {
                            const parsedData = JSON.parse(cached);
                            const migratedData = migrateData(parsedData);
                            setPeople(migratedData);
                        } catch (e) {}
                    }

                    // Then fetch from JSONBin for the "truth"
                    try {
                        const response = await fetch(JSONBIN_URL + '/latest', {
                            headers: {
                                'X-Master-Key': JSONBIN_API_KEY
                            }
                        });

                        if (response.ok) {
                            const data = await response.json();
                            let remotePeople = data.record;
                            if (Array.isArray(remotePeople)) {
                                remotePeople = migrateData(remotePeople);
                                setPeople(remotePeople);
                                localStorage.setItem('tom_gift_tracker_v1', JSON.stringify(remotePeople));
                            }
                            setSyncStatus('synced');
                        } else {
                            setSyncStatus('error');
                        }
                    } catch (e) {
                        console.error('Failed to load from JSONBin:', e);
                        setSyncStatus('offline');
                    }

                    setIsLoaded(true);
                };

                loadData();
            }, []);

            // Save to JSONBin (debounced)
            const saveToCloud = useCallback(async (dataToSave) => {
                setSyncStatus('syncing');
                
                try {
                    const response = await fetch(JSONBIN_URL, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': JSONBIN_API_KEY
                        },
                        body: JSON.stringify(dataToSave)
                    });
                    
                    if (response.ok) {
                        setSyncStatus('synced');
                    } else {
                        setSyncStatus('error');
                    }
                } catch (e) {
                    console.error('Failed to save to JSONBin:', e);
                    setSyncStatus('offline');
                }
            }, []);

            // Debounced save whenever people change
            useEffect(() => {
                if (!isLoaded) return;

                // Always save to localStorage immediately
                localStorage.setItem('tom_gift_tracker_v1', JSON.stringify(people));

                // Debounce cloud save by 1 second
                if (saveTimeoutRef.current) {
                    clearTimeout(saveTimeoutRef.current);
                }

                saveTimeoutRef.current = setTimeout(() => {
                    saveToCloud(people);
                }, 1000);

                return () => {
                    if (saveTimeoutRef.current) {
                        clearTimeout(saveTimeoutRef.current);
                    }
                };
            }, [people, isLoaded, saveToCloud]);

            const addPerson = () => {
                const newPerson = {
                    id: `person-${Date.now()}`,
                    recipient: 'New Person',
                    assignedTo: '',
                    gifts: [{
                        id: `gift-${Date.now()}`,
                        item: '',
                        price: 0,
                        budget: 0,
                        status: 'Idea',
                        link: '',
                        notes: '',
                        expectedDelivery: ''
                    }]
                };
                setPeople([...people, newPerson]);
                setEditingPersonId(newPerson.id);
                setEditingGiftId(newPerson.gifts[0].id);
                setExpandedPeople(new Set([...expandedPeople, newPerson.id]));
            };

            const addGiftToPerson = (personId) => {
                const newGift = {
                    id: `gift-${Date.now()}`,
                    item: '',
                    price: 0,
                    budget: 0,
                    status: 'Idea',
                    link: '',
                    notes: '',
                    expectedDelivery: ''
                };

                setPeople(people.map(p => {
                    if (p.id === personId) {
                        return { ...p, gifts: [...p.gifts, newGift] };
                    }
                    return p;
                }));
                setEditingGiftId(newGift.id);
            };

            const updatePerson = (personId, field, value) => {
                setPeople(people.map(p => p.id === personId ? { ...p, [field]: value } : p));
            };

            const updateGift = (personId, giftId, field, value) => {
                setPeople(people.map(p => {
                    if (p.id === personId) {
                        return {
                            ...p,
                            gifts: p.gifts.map(g => g.id === giftId ? { ...g, [field]: value } : g)
                        };
                    }
                    return p;
                }));
            };

            const deletePerson = (personId) => {
                const person = people.find(p => p.id === personId);
                if (window.confirm(`Remove ${person.recipient} and all their gifts from the list?`)) {
                    setPeople(people.filter(p => p.id !== personId));
                }
            };

            const deleteGift = (personId, giftId) => {
                const person = people.find(p => p.id === personId);
                if (person.gifts.length === 1) {
                    if (window.confirm(`This is the last gift for ${person.recipient}. Remove the entire person from the list?`)) {
                        deletePerson(personId);
                    }
                } else {
                    setPeople(people.map(p => {
                        if (p.id === personId) {
                            return { ...p, gifts: p.gifts.filter(g => g.id !== giftId) };
                        }
                        return p;
                    }));
                }
            };

            const nextStatus = (personId, giftId, current) => {
                const cycle = ['Idea', 'Ordered', 'Received', 'Wrapped'];
                const idx = cycle.indexOf(current);
                const next = cycle[(idx + 1) % cycle.length];
                updateGift(personId, giftId, 'status', next);
            };

            const toggleExpanded = (personId) => {
                const newExpanded = new Set(expandedPeople);
                if (newExpanded.has(personId)) {
                    newExpanded.delete(personId);
                } else {
                    newExpanded.add(personId);
                }
                setExpandedPeople(newExpanded);
            };

            const generateMarkdown = () => {
                let md = `# üéÑ Tom's Gift List 2025\n\n`;

                let totalSpent = 0;
                let totalBudget = 0;
                people.forEach(person => {
                    person.gifts.forEach(gift => {
                        totalSpent += Number(gift.price) || 0;
                        totalBudget += Number(gift.budget) || 0;
                    });
                });

                md += `**Total Spent:** $${totalSpent} | **Total Budget:** $${totalBudget}\n\n`;
                md += `| Status | Recipient | Assigned | Gift Idea | Price | Budget | Delivery | Notes |\n`;
                md += `| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |\n`;

                people.forEach(person => {
                    const assigned = person.assignedTo || '-';
                    person.gifts.forEach(gift => {
                        const statusIcon = gift.status === 'Wrapped' ? '‚úÖ' : gift.status === 'Ordered' ? 'üöö' : gift.status === 'Received' ? 'üì¶' : '‚ö™';
                        const delivery = gift.expectedDelivery || '-';
                        md += `| ${statusIcon} ${gift.status} | ${person.recipient} | ${assigned} | ${gift.item} | $${gift.price} | $${gift.budget} | ${delivery} | ${gift.notes} ${gift.link ? `[Link](${gift.link})` : ''} |\n`;
                    });
                });
                return md;
            };

            const copyToClipboard = () => {
                const md = generateMarkdown();
                navigator.clipboard.writeText(md);
                alert("Copied Markdown to clipboard! You can paste this into Claude/Gemini or Google Keep.");
            };

            const parseImport = () => {
                try {
                    const data = JSON.parse(importText);
                    if (Array.isArray(data)) {
                        const migratedData = migrateData(data);
                        setPeople(migratedData);
                        setIsImportModalOpen(false);
                        setImportText('');
                        alert("Imported successfully!");
                        return;
                    }
                } catch (e) {
                    alert("Could not parse data. Please use the JSON format for importing data.");
                }
            };

            const copyJSON = () => {
                const json = JSON.stringify(people, null, 2);
                navigator.clipboard.writeText(json);
                alert("Copied raw data (JSON) to clipboard!");
            };

            const forceSync = async () => {
                setSyncStatus('syncing');
                try {
                    const response = await fetch(JSONBIN_URL + '/latest', {
                        headers: {
                            'X-Master-Key': JSONBIN_API_KEY
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        let remotePeople = data.record;
                        if (Array.isArray(remotePeople)) {
                            remotePeople = migrateData(remotePeople);
                            setPeople(remotePeople);
                            localStorage.setItem('tom_gift_tracker_v1', JSON.stringify(remotePeople));
                        }
                        setSyncStatus('synced');
                    } else {
                        setSyncStatus('error');
                    }
                } catch (e) {
                    setSyncStatus('offline');
                }
            };

            // Calculations
            let totalBudget = 0;
            let totalSpent = 0;
            let totalGifts = 0;
            let wrappedGifts = 0;

            people.forEach(person => {
                person.gifts.forEach(gift => {
                    totalBudget += Number(gift.budget) || 0;
                    totalSpent += Number(gift.price) || 0;
                    totalGifts++;
                    if (gift.status === 'Wrapped') wrappedGifts++;
                });
            });

            const percentComplete = Math.round((wrappedGifts / totalGifts) * 100) || 0;

            // Sorting logic
            const getSortedPeople = () => {
                const sorted = [...people];

                if (sortBy === 'recipient') {
                    sorted.sort((a, b) => a.recipient.localeCompare(b.recipient));
                } else if (sortBy === 'assigned') {
                    sorted.sort((a, b) => {
                        const aVal = a.assignedTo || 'zzz'; // Unassigned goes last
                        const bVal = b.assignedTo || 'zzz';
                        return aVal.localeCompare(bVal);
                    });
                } else if (sortBy === 'status') {
                    // Sort by overall completion: wrapped last, then by percentage complete
                    sorted.sort((a, b) => {
                        const aWrapped = a.gifts.filter(g => g.status === 'Wrapped').length;
                        const bWrapped = b.gifts.filter(g => g.status === 'Wrapped').length;
                        const aTotal = a.gifts.length;
                        const bTotal = b.gifts.length;
                        const aPercent = aTotal > 0 ? aWrapped / aTotal : 0;
                        const bPercent = bTotal > 0 ? bWrapped / bTotal : 0;

                        // If all wrapped, put at end
                        if (aPercent === 1 && bPercent !== 1) return 1;
                        if (bPercent === 1 && aPercent !== 1) return -1;

                        // Otherwise sort by completion percentage (ascending - least complete first)
                        return aPercent - bPercent;
                    });
                }

                return sorted;
            };

            const sortedPeople = getSortedPeople();

            return (
                <div className="min-h-screen pb-32">
                    
                    {/* Header */}
                    <div className="max-w-5xl mx-auto mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4 p-4 md:p-8 md:pb-0">
                        <div>
                            <h1 className="text-3xl font-bold text-slate-800 flex items-center gap-2">
                                <Icons.Gift className="text-red-500 w-8 h-8" /> 
                                Christmas Command Center
                            </h1>
                            <div className="flex items-center gap-3 mt-1">
                                <p className="text-slate-500 text-sm">Ontario ‚Ä¢ 2025 ‚Ä¢ Black Friday Edition</p>
                                <button onClick={forceSync} className="hover:opacity-70 transition-opacity" title="Click to refresh from cloud">
                                    <SyncStatus status={syncStatus} />
                                </button>
                            </div>
                        </div>
                        
                        <div className="flex gap-2">
                            <button onClick={copyToClipboard} className="flex items-center gap-2 px-4 py-2 bg-white border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-50 transition-colors shadow-sm">
                                <Icons.Copy /> Copy Summary (MD)
                            </button>
                            <button onClick={copyJSON} className="flex items-center gap-2 px-4 py-2 bg-white border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-50 transition-colors shadow-sm">
                                <Icons.Save /> Backup Data
                            </button>
                            <button onClick={() => setIsImportModalOpen(true)} className="flex items-center gap-2 px-4 py-2 bg-white border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-50 transition-colors shadow-sm">
                                <Icons.Upload /> Import
                            </button>
                        </div>
                    </div>

                    {/* Metrics Cards */}
                    <div className="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 px-4 md:px-8">
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                            <div className="flex items-center gap-2 mb-2 text-slate-500 text-sm font-medium">
                                <Icons.DollarSign /> Budget Used
                            </div>
                            <div className="text-3xl font-bold text-slate-800">
                                ${totalSpent.toLocaleString()}
                            </div>
                            <div className="text-sm text-slate-400 mt-1">
                                of ${totalBudget.toLocaleString()} planned
                            </div>
                            <div className="mt-3">
                                <ProgressBar current={totalSpent} max={totalBudget} label="" />
                            </div>
                        </div>

                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                            <div className="flex items-center gap-2 mb-2 text-slate-500 text-sm font-medium">
                                <Icons.Users /> People
                            </div>
                            <div className="text-3xl font-bold text-slate-800">
                                {people.length}
                            </div>
                            <div className="text-sm text-slate-400 mt-1">
                                {totalGifts} total gifts
                            </div>
                        </div>

                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                            <div className="flex items-center gap-2 mb-2 text-slate-500 text-sm font-medium">
                                <Icons.CheckCircle2 /> Completion
                            </div>
                            <div className="text-3xl font-bold text-slate-800">
                                {percentComplete}%
                            </div>
                            <div className="text-sm text-slate-400 mt-1">
                                Wrapped & Ready
                            </div>
                            <div className="mt-3">
                                <div className="h-2 w-full bg-gray-200 rounded-full overflow-hidden">
                                    <div className="h-full bg-green-500" style={{ width: `${percentComplete}%` }} />
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Sorting Controls */}
                    <div className="max-w-5xl mx-auto px-4 md:px-8 mb-4">
                        <div className="flex items-center gap-2">
                            <span className="text-sm font-medium text-slate-600">Sort by:</span>
                            <div className="flex gap-1 bg-white border border-slate-200 rounded-lg p-1">
                                <button onClick={() => setSortBy('recipient')} className={`px-3 py-1 text-sm font-medium rounded transition-colors ${sortBy === 'recipient' ? 'bg-indigo-100 text-indigo-700' : 'text-slate-600 hover:bg-slate-50'}`}>
                                    Name
                                </button>
                                <button onClick={() => setSortBy('status')} className={`px-3 py-1 text-sm font-medium rounded transition-colors ${sortBy === 'status' ? 'bg-indigo-100 text-indigo-700' : 'text-slate-600 hover:bg-slate-50'}`}>
                                    Status
                                </button>
                                <button onClick={() => setSortBy('assigned')} className={`px-3 py-1 text-sm font-medium rounded transition-colors ${sortBy === 'assigned' ? 'bg-indigo-100 text-indigo-700' : 'text-slate-600 hover:bg-slate-50'}`}>
                                    Assigned
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Main List - Person Cards */}
                    <div className="max-w-5xl mx-auto space-y-4 px-4 md:px-8">
                        {sortedPeople.map(person => {
                            const personBudget = person.gifts.reduce((sum, g) => sum + (Number(g.budget) || 0), 0);
                            const personSpent = person.gifts.reduce((sum, g) => sum + (Number(g.price) || 0), 0);
                            const wrappedCount = person.gifts.filter(g => g.status === 'Wrapped').length;
                            const allWrapped = wrappedCount === person.gifts.length;
                            const isExpanded = expandedPeople.has(person.id);

                            return (
                                <div key={person.id} className={`bg-white rounded-xl shadow-sm border transition-all ${allWrapped ? 'border-green-200 bg-green-50/30' : 'border-slate-200'}`}>
                                    {/* Person Header - Always Visible */}
                                    <div className="p-4 md:p-6">
                                        <div className="flex flex-col md:flex-row gap-4 items-start md:items-center">
                                            <div className="flex-grow min-w-0">
                                                <div className="flex items-center gap-2 flex-wrap">
                                                    <h3 className={`font-bold text-lg ${allWrapped ? 'text-slate-500 line-through' : 'text-slate-800'}`}>
                                                        {person.recipient}
                                                    </h3>
                                                    {person.assignedTo && (
                                                        <span className={`text-xs px-2 py-0.5 rounded-full font-medium ${person.assignedTo === 'Tom' ? 'bg-blue-100 text-blue-700' : 'bg-pink-100 text-pink-700'}`}>
                                                            {person.assignedTo}
                                                        </span>
                                                    )}
                                                    <span className="text-xs text-slate-400">
                                                        {person.gifts.length} {person.gifts.length === 1 ? 'gift' : 'gifts'} ‚Ä¢ {wrappedCount} wrapped
                                                    </span>
                                                </div>
                                            </div>

                                            <div className="flex-shrink-0 flex flex-row items-center gap-4 text-sm">
                                                <div className="text-right">
                                                    <div className="text-slate-500 text-xs">Budget</div>
                                                    <div className="font-medium">${personBudget}</div>
                                                </div>
                                                <div className="text-right">
                                                    <div className="text-slate-500 text-xs">Spent</div>
                                                    <div className={`font-bold ${personSpent > personBudget && personBudget > 0 ? 'text-red-600' : 'text-slate-800'}`}>
                                                        ${personSpent}
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="flex gap-2">
                                                <button onClick={() => setEditingPersonId(person.id)} className="p-2 text-slate-400 hover:text-indigo-500 hover:bg-indigo-50 rounded-lg" title="Edit person details">
                                                    <Icons.Edit2 />
                                                </button>
                                                <button onClick={() => toggleExpanded(person.id)} className="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-50 rounded-lg" title={isExpanded ? "Collapse" : "Expand"}>
                                                    <svg className={`w-5 h-5 transition-transform ${isExpanded ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>

                                        {/* Edit Person Form */}
                                        {editingPersonId === person.id && (
                                            <div className="mt-4 pt-4 border-t border-slate-200">
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                                    <div>
                                                        <label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Recipient Name</label>
                                                        <input type="text" value={person.recipient} onChange={(e) => updatePerson(person.id, 'recipient', e.target.value)} className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" />
                                                    </div>
                                                    <div>
                                                        <label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Assigned To</label>
                                                        <select value={person.assignedTo || ''} onChange={(e) => updatePerson(person.id, 'assignedTo', e.target.value)} className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
                                                            <option value="">Unassigned</option>
                                                            <option value="Tom">Tom</option>
                                                            <option value="Evelyn">Evelyn</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div className="flex justify-between items-center">
                                                    <button onClick={() => deletePerson(person.id)} className="text-red-500 text-sm hover:underline px-2">Delete Person</button>
                                                    <button onClick={() => setEditingPersonId(null)} className="bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-700 transition-colors">Done</button>
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    {/* Expanded Gift List */}
                                    {isExpanded && (
                                        <div className="px-4 md:px-6 pb-4 space-y-3 border-t border-slate-100">
                                            {person.gifts.map(gift => (
                                                <div key={gift.id} className={`p-4 rounded-lg border ${editingGiftId === gift.id ? 'bg-slate-50 border-slate-300' : 'bg-white border-slate-200'}`}>
                                                    {editingGiftId !== gift.id ? (
                                                        <div className="flex flex-col md:flex-row gap-3 items-start md:items-center">
                                                            <button onClick={() => nextStatus(person.id, gift.id, gift.status)} className="flex-shrink-0 cursor-pointer hover:opacity-80 transition-opacity" title="Click to cycle status">
                                                                <StatusBadge status={gift.status} />
                                                            </button>

                                                            <div className="flex-grow min-w-0">
                                                                <div className="font-medium text-slate-800">
                                                                    {gift.item || <span className="text-slate-400 italic">No item specified...</span>}
                                                                </div>
                                                                {gift.expectedDelivery && (
                                                                    <div className="text-xs text-slate-400 mt-1">
                                                                        üöö Expected: {gift.expectedDelivery}
                                                                    </div>
                                                                )}
                                                                {gift.notes && (
                                                                    <div className="text-slate-400 text-xs mt-1">
                                                                        üìù {gift.notes}
                                                                    </div>
                                                                )}
                                                            </div>

                                                            <div className="flex-shrink-0 flex items-center gap-3 text-sm">
                                                                <div className="text-slate-500">
                                                                    Budget: <span className="font-medium">${gift.budget}</span>
                                                                </div>
                                                                <div className={`font-bold ${gift.price > gift.budget && gift.budget > 0 ? 'text-red-600' : 'text-slate-800'}`}>
                                                                    Spent: ${gift.price}
                                                                </div>
                                                            </div>

                                                            <div className="flex gap-2 border-l pl-3 border-slate-200">
                                                                {gift.link && (
                                                                    <a href={gift.link} target="_blank" rel="noopener noreferrer" className="p-2 text-slate-400 hover:text-blue-500 hover:bg-blue-50 rounded-lg">
                                                                        <Icons.ExternalLink />
                                                                    </a>
                                                                )}
                                                                <button onClick={() => setEditingGiftId(gift.id)} className="p-2 text-slate-400 hover:text-indigo-500 hover:bg-indigo-50 rounded-lg">
                                                                    <Icons.Edit2 />
                                                                </button>
                                                            </div>
                                                        </div>
                                                    ) : (
                                                        <div>
                                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                                                <div className="md:col-span-2">
                                                                    <label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Gift Item</label>
                                                                    <input type="text" value={gift.item} onChange={(e) => updateGift(person.id, gift.id, 'item', e.target.value)} className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" />
                                                                </div>
                                                                <div>
                                                                    <label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Budget ($)</label>
                                                                    <input type="number" value={gift.budget} onChange={(e) => updateGift(person.id, gift.id, 'budget', Number(e.target.value))} className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" />
                                                                </div>
                                                                <div>
                                                                    <label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Actual Price ($)</label>
                                                                    <input type="number" value={gift.price} onChange={(e) => updateGift(person.id, gift.id, 'price', Number(e.target.value))} className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" />
                                                                </div>
                                                                <div>
                                                                    <label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Status</label>
                                                                    <select value={gift.status} onChange={(e) => updateGift(person.id, gift.id, 'status', e.target.value)} className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
                                                                        <option value="Idea">Idea</option>
                                                                        <option value="Ordered">Ordered</option>
                                                                        <option value="Received">Received</option>
                                                                        <option value="Wrapped">Wrapped</option>
                                                                    </select>
                                                                </div>
                                                                <div>
                                                                    <label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Expected Delivery</label>
                                                                    <input type="date" value={gift.expectedDelivery || ''} onChange={(e) => updateGift(person.id, gift.id, 'expectedDelivery', e.target.value)} className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" />
                                                                </div>
                                                                <div className="md:col-span-2">
                                                                    <label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Web Link</label>
                                                                    <input type="text" placeholder="https://..." value={gift.link} onChange={(e) => updateGift(person.id, gift.id, 'link', e.target.value)} className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" />
                                                                </div>
                                                                <div className="md:col-span-2">
                                                                    <label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Notes</label>
                                                                    <textarea value={gift.notes} onChange={(e) => updateGift(person.id, gift.id, 'notes', e.target.value)} className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none h-20" />
                                                                </div>
                                                            </div>
                                                            <div className="flex justify-between items-center border-t border-slate-200 pt-4">
                                                                <button onClick={() => deleteGift(person.id, gift.id)} className="text-red-500 text-sm hover:underline px-2">Delete Gift</button>
                                                                <button onClick={() => setEditingGiftId(null)} className="bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-700 transition-colors">Done</button>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            ))}

                                            <button onClick={() => addGiftToPerson(person.id)} className="w-full py-3 border-2 border-dashed border-slate-300 rounded-lg text-slate-400 text-sm font-medium hover:border-indigo-400 hover:text-indigo-500 hover:bg-indigo-50 transition-all flex items-center justify-center gap-2">
                                                <Icons.Plus className="w-4 h-4" /> Add Gift for {person.recipient}
                                            </button>
                                        </div>
                                    )}
                                </div>
                            );
                        })}

                        <button onClick={addPerson} className="w-full py-4 border-2 border-dashed border-slate-300 rounded-xl text-slate-400 font-medium hover:border-indigo-400 hover:text-indigo-500 hover:bg-indigo-50 transition-all flex items-center justify-center gap-2">
                            <Icons.Plus /> Add Person
                        </button>
                    </div>

                    {isImportModalOpen && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl shadow-xl max-w-lg w-full p-6">
                                <h2 className="text-xl font-bold mb-4">Import Data</h2>
                                <p className="text-sm text-slate-600 mb-4">
                                    Paste the JSON data you exported previously.<br/>
                                    <span className="text-xs text-red-500 italic">Warning: This will overwrite your current list.</span>
                                </p>
                                <textarea className="w-full h-40 border border-slate-300 rounded-lg p-3 text-xs font-mono mb-4 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder='[{"id":"1", "recipient":"Dad"...}]' value={importText} onChange={(e) => setImportText(e.target.value)} />
                                <div className="flex justify-end gap-2">
                                    <button onClick={() => setIsImportModalOpen(false)} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg">Cancel</button>
                                    <button onClick={parseImport} className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Import</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<GiftTracker />);
    </script>
</body>
</html>
